#####################################################################################################
##### NSPANEL ESPHOME created by Blackymas - https://github.com/Blackymas/NSPanel_HA_Blueprint  #####
##### ESPHOME Hardware - Temperature                                                            #####
##### PLEASE only make changes if it is necessary and also the required knowledge is available. #####
##### For normal use with the Blueprint, no changes are necessary.                              #####
#####################################################################################################
---
substitutions:
  ##############################
  ## Change only in your      ##
  ## local yaml substitutions ##
  temp_units: "°C"
  ##############################
  TEMP_UNIT_IS_FAHRENHEIT: ${temp_units == "°F" or temp_units == "F" or temp_units == "°f" or temp_units == "f"}
  BOOT_STEP_HW_TEMPERATURE: '8'
  GPIO_TEMPERATURE_ADC_PIN: 38
  ntc_source_filter_delta: 0.002  # adjust to your sensor's voltage jitter level
  ntc_source_filter_heartbeat: 5min
  TAG_HW_TEMPERATURE: nspanel.hw.temperature

esphome:
  platformio_options:
    build_flags:
      - -D NSPANEL_HA_BLUEPRINT_HW_TEMPERATURE
      - -D NSPANEL_HA_BLUEPRINT_HW_TEMPERATURE_IS_FAHRENHEIT=${1 if TEMP_UNIT_IS_FAHRENHEIT else 0}

globals:
  - id: embedded_indoor_temp  # Is embedded sensor used for indoor temperature?
    type: bool
    restore_value: true
    initial_value: 'true'

number:
  - id: temperature_correction  # Temperature correction
    name: Temperature Correction
    platform: template
    entity_category: config
    unit_of_measurement: ${temp_units}
    min_value: ${ -18.0 if TEMP_UNIT_IS_FAHRENHEIT else -10.0 }
    max_value: ${ 18.0 if TEMP_UNIT_IS_FAHRENHEIT else 10.0 }
    initial_value: 0
    step: ${ 1.0 if TEMP_UNIT_IS_FAHRENHEIT else 0.1 }
    mode: box
    restore_value: true
    internal: false
    optimistic: true
    update_interval: never
    on_value:
      then:
        - logger.log: Temperature correction changed.
        - delay: 1s
        - lambda: temp_nspanel->publish_state(temp_nspanel->raw_state);

script:
  - id: !extend action_component_val
    then:
      - lambda: |-
          if (page == "mem") {
            if (component == "embedded_indoor_temperature") {
              id(embedded_indoor_temp) = (val>0);
            }
          }

  - id: display_embedded_temp  # Show panel's temperature if selected, or API or Wi-Fi are out
    mode: single
    then:
      - lambda: |-
          if (system_flags.tft_upload_active) return;
          if (!id(embedded_indoor_temp) and
              system_flags.api_ready and
              system_flags.wifi_ready and
              current_page_id != ${PAGE_BOOT_ID})
            return;
          if (isnan(temp_nspanel->state)) {
            disp1->set_component_text(hmi::home::INDR_TEMP.name, "");
            return;
          }

          static char buffer[15];
          #if NSPANEL_HA_BLUEPRINT_HW_TEMPERATURE_IS_FAHRENHEIT
          // Fahrenheit with no decimal
          snprintf(buffer, sizeof(buffer), "%.0f${temp_units}", temp_nspanel->state);
          #else
          // Celsius with one decimal
          snprintf(buffer, sizeof(buffer), "%.1f${temp_units}", temp_nspanel->state);
          #endif

          disp1->set_component_text(hmi::home::INDR_TEMP.name,
                                    adjustDecimalSeparator(buffer, id(mui_decimal_separator)[0]).c_str());

  - id: !extend dump_config
    then:
      - lambda: |-
          ESP_LOGCONFIG("${TAG_HW_TEMPERATURE}", "Temperature unit: ${temp_units}");

  - id: !extend page_home
    then:
      - script.execute: display_embedded_temp

  - id: !extend stop_all
    then:
      - lambda: display_embedded_temp->stop();

sensor:
  # 1) Raw ADC - fast sampling, early spike removal
  - id: ntc_source
    platform: adc
    pin: ${GPIO_TEMPERATURE_ADC_PIN}
    attenuation: 12db
    samples: 16
    update_interval: 1s
    internal: true

    filters:
      # (A) Remove single-spike noise
      - median:
          window_size: 5
          send_every: 1
          send_first_at: 1

      # (B) Smooth the curve
      - exponential_moving_average:
          alpha: 0.2
          send_every: 1
          send_first_at: 1

      # (C) Only publish when the smoothed value actually changes
      - delta: ${ntc_source_filter_delta}

      # (D) If nothing changes, publish once every 5 minutes
      - heartbeat: ${ntc_source_filter_heartbeat}

  # 2) Convert to resistance
  - id: resistance_sensor
    platform: resistance
    sensor: ntc_source
    configuration: DOWNSTREAM
    resistor: 11.2kOhm
    internal: true

  # 3) Temperature (HA-facing)
  - id: temp_nspanel
    name: Temperature
    platform: ntc
    sensor: resistance_sensor
    unit_of_measurement: ${temp_units}
    accuracy_decimals: ${0 if TEMP_UNIT_IS_FAHRENHEIT else 1}
    internal: false
    calibration:
      b_constant: 3950
      reference_temperature: ${'77°F' if TEMP_UNIT_IS_FAHRENHEIT else '25°C'}
      reference_resistance: 10kOhm

    filters:
      # Publish only when temperature changes meaningfully
      - delta: ${0.1 if TEMP_UNIT_IS_FAHRENHEIT else 0.01}

      # Apply offset
      - lambda: |-
          return x + temperature_correction->state;

    on_value:
      then:
        - script.execute: display_embedded_temp
...
