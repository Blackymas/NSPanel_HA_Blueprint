#####################################################################################################
##### NSPANEL ESPHOME created by Blackymas - https://github.com/Blackymas/NSPanel_HA_Blueprint  #####
##### ESPHOME - Page Settings                                                                   #####
##### PLEASE only make changes if it is necessary and also the required knowledge is available. #####
##### For normal use with the Blueprint, no changes are necessary.                              #####
#####################################################################################################

---
substitutions:
  BOOT_STEP_PAGE_SETTINGS: 28
  PAGE_SETTINGS_ID: 8
  TAG_PAGE_SETTINGS: nspanel.page.settings

display:
  - id: !extend disp1
    on_touch:
      then:
        - lambda: |-
            if (
                  !touch_event and  // Only act with release
                  page_id == ${PAGE_SETTINGS_ID} and
                  component_id == 9  // Reboot button
                ) {
              screen_power->turn_off();
              App.safe_reboot();
            }

esphome:
  platformio_options:
    build_flags:
      - -D NSPANEL_HA_BLUEPRINT_PAGE_SETTINGS

number:
  - id: !extend display_brightness
    on_value:
      then:
        - lambda: |-
            disp1->set_component_value("settings.brightslider", int(x));
            if (current_page_id == ${PAGE_SETTINGS_ID})
              disp1->set_component_text_printf("bright_text", "%i%%", int(x));

  - id: !extend display_dim_brightness
    on_value:
      then:
        - lambda: |-
            disp1->set_component_value("settings.dimslider", int(x));
            if (current_page_id == ${PAGE_SETTINGS_ID})
              disp1->set_component_text_printf("dim_text", "%i%%", int(x));

script:
  - id: !extend event_from_display_legacy
    parameters:
      json: JsonDocument
      page: string
      event: string
    then:
      - lambda: |-
          if (page == "settings") {
            const uint8_t value = json["value"].isNull() ? UINT8_MAX : json["value"].as<uint8_t>();
            if (value > 100) {
              ESP_LOGV("${TAG_PAGE_SETTINGS}", "Invalid json:");
              ESP_LOGV("${TAG_PAGE_SETTINGS}", "  event: %s", event.c_str());
              ESP_LOGV("${TAG_PAGE_SETTINGS}", "  value: %" PRIu8, value);
              return;
            }
            if (event == "bright") {
              auto call = id(display_brightness).make_call();
              call.set_value(value);
              call.perform();
              return;
            }
            if (event == "dim") {
              auto call = id(display_dim_brightness).make_call();
              call.set_value(value);
              call.perform();
              return;
            }
          }

  - id: !extend page_change
    then:
      - lambda: |-
          if (new_page_id == ${PAGE_SETTINGS_ID})
            page_settings->execute();

  - id: page_settings
    mode: single
    then:
      - lambda: |-
          if (current_page_id == ${PAGE_SETTINGS_ID}) {
            disp1->hide_component("lbl_sleep");
            disp1->hide_component("bt_sleep");
          }

  - id: !extend stop_page_constructors
    then:
      - lambda: page_settings->stop();
...
