#####################################################################################################
##### NSPANEL ESPHOME created by Blackymas - https://github.com/Blackymas/NSPanel_HA_Blueprint  #####
##### ESPHOME CORE - Base                                                                       #####
##### PLEASE only make changes if it is necessary and also the required knowledge is available. #####
##### For normal use with the Blueprint, no changes are necessary.                              #####
#####################################################################################################

---
substitutions:
  ##############################
  ## Change only in your      ##
  ## local yaml substitutions ##
  ##############################
  device_name: nspanel
  name: ${device_name}
  friendly_name: ${device_name}
  ota_password: ${wifi_password}
  project_tag: nspanel_ha_blueprint
  BOOT_STEP_BASE: '0'
  TAG_BASE: nspanel.base
  GPIO_PSRAM_CLK_PIN: '5'
  GPIO_PSRAM_CS_PIN: '18'

button:
  - id: nspanel_factory_reset  # Factory Reset button - Used to clean values from flash
    name: Factory reset
    platform: factory_reset
    internal: false
    disabled_by_default: true
    icon: mdi:restart-alert

  - id: restart_nspanel  # Reboot ESP32
    name: Restart
    platform: restart

esphome:
  name: ${name}
  friendly_name: ${friendly_name}
  comment: NSPanel HA Blueprint
  project:
    name: Blackymas.NSPanel_HA_Blueprint
    version: ${version}
  platformio_options:
    build_flags:
      - -Wno-missing-field-initializers
      - -D NSPANEL_HA_BLUEPRINT_CORE_BASE
  min_version: 2025.8.0
  on_boot:
    - priority: 600.${BOOT_STEP_BASE}  # This is where most sensors are set up
      then:
        - if:
            condition:
              - switch.is_off: screen_power
            then:
              - switch.turn_on: screen_power
  on_shutdown:
    then:
      - if:
          condition:
            - lambda: return not is_system_flag_set(system_flags, NSPanelFlag::TFT_UPLOAD_ACTIVE);
          then:
            - switch.turn_off: screen_power

external_components:
  - source:
      type: git
      url: https://github.com/Blackymas/NSPanel_HA_Blueprint
      ref: v${version}
    refresh: 300s
    components:
      - nspanel_ha_blueprint

logger:

nspanel_ha_blueprint:  # Adds custom library for NSPanel HA Blueprint project

ota:
  - id: ota_std
    platform: esphome
    password: ${ota_password}

safe_mode:
  num_attempts: 5
  reboot_timeout: 10min

script:
  - id: dump_config
    mode: restart
    then:
      - delay: 10s

  - id: report_device_not_available
    mode: single
    parameters:
      request: string
    then:
      - lambda: |-
          std::string blocking_flags = "";
          if (is_system_flag_set(system_flags, NSPanelFlag::OTA_IN_PROGRESS)) {
            if (!blocking_flags.empty()) blocking_flags += ", ";
            blocking_flags += "OTA";
          }  // if OTA in progress
          if (is_system_flag_set(system_flags, NSPanelFlag::TFT_UPLOAD_ACTIVE)) {
            if (!blocking_flags.empty()) blocking_flags += ", ";
            blocking_flags += "TFT_UPLOAD";
          }  // if TFT upload active
          if (is_system_flag_set(system_flags, NSPanelFlag::SAFE_MODE_ACTIVE)) {
            if (!blocking_flags.empty()) blocking_flags += ", ";
            blocking_flags += "SAFE_MODE";
          }  // if safe mode active

          ESP_LOGW("${TAG_BASE}", "Device not available - cannot handle '%s' request (blocking: %s)",
                                  request.c_str(), blocking_flags.c_str());

  - id: stop_all
    mode: restart
    then:
      - script.stop: dump_config
      - script.stop: report_device_not_available
...
