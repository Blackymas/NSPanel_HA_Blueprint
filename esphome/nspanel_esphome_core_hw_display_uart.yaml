#####################################################################################################
##### NSPANEL ESPHOME created by Blackymas - https://github.com/Blackymas/NSPanel_HA_Blueprint  #####
##### ESPHOME CORE - HARDWARE - Display - UART                                                  #####
##### PLEASE only make changes if it is necessary and also the required knowledge is available. #####
##### For normal use with the Blueprint, no changes are necessary.                              #####
#####################################################################################################

---
substitutions:
  BAUD_RATE: '921600'
  MAX_SCAN_RETRIES: '255'  # Maximum number of complete scan cycles, limited to 255 (UINT8_MAX)
  SCAN_INTERVAL: '500'     # Interval between connection checks in ms
  VERIFY_DELAY: '1000'     # Delay before verifying connection in ms
  WAIT_TIME: '10000'       # Time to wait for the Nextion display to respond
  GPIO_DISPLAY_NEXTION_TX_PIN: '16'
  GPIO_DISPLAY_NEXTION_RX_PIN: '17'
  TAG_CORE_HW_DISPLAY_UART: core_hw_display_uart

display:
  - id: !extend disp1
    uart_id: tf_uart
    on_setup:
      then:
        - lambda: |-
            // Set the current baud rate into the display
            disp1->send_command_printf("bauds=%" PRIu32, tf_uart->get_baud_rate());

esphome:
  on_boot:
    - priority: 600.${BOOT_STEP_HW_DISPLAY}  # Before other display initialization
      then:
        - script.execute: boot_scan_baud_rate

globals:
  - id: baud_error_count
    type: uint8_t
    restore_value: true
    initial_value: '0'

  - id: baud_scan_index
    type: uint8_t
    restore_value: false
    initial_value: '0'

  - id: baud_scan_retries
    type: uint8_t
    restore_value: false
    initial_value: '0'

script:
  - id: boot_scan_baud_rate
    mode: restart
    then:
      - wait_until:
          condition:
            - lambda: return not isnan(tf_uart->get_baud_rate());
          timeout: 15s
      - wait_until:
          condition: &nextion_is_detected
            - lambda: return disp1->is_detected();
          timeout: 5s
      - if:
          condition: *nextion_is_detected
          then:
            - lambda: |-
                ESP_LOGI("${TAG_CORE_HW_DISPLAY_UART}", "Connected at %" PRIu32 "bps", tf_uart->get_baud_rate());
            - if:
                condition: &baud_rate_mismatch
                  - lambda: return (tf_uart->get_baud_rate() != ${BAUD_RATE});
                then:
                  - lambda: |-
                      ESP_LOGW("${TAG_CORE_HW_DISPLAY_UART}", "Switch to ${BAUD_RATE}bps");
                      tf_uart->write_str("bauds=${BAUD_RATE}");
                      tf_uart->write_array((const uint8_t[]){0xFF, 0xFF, 0xFF}, 3);
                      disp1->send_command("bauds=${BAUD_RATE}");
                  - delay: 2s
      - if:
          condition:
            - or:
                - not: *nextion_is_detected
                - or: *baud_rate_mismatch
          then:
            - lambda: |-
                ESP_LOGW("${TAG_CORE_HW_DISPLAY_UART}", "Scan baud rate...");
            - while:
                condition:
                  or:
                    - lambda: return not disp1->is_detected();
                    - lambda: return (tf_uart->get_baud_rate() != ${BAUD_RATE});
                then:
                  - if:
                      condition: &nextion_is_NOT_connected
                        - lambda: return not disp1->is_detected();
                      then:
                        - logger.log: Waiting for Nextion
                        - repeat:
                            count: 5
                            then:
                              - if:
                                  condition: *nextion_is_NOT_connected
                                  then:
                                    - wait_until:
                                        condition: *nextion_is_detected
                                        timeout: 1s  # ${WAIT_TIME}ms
                  - if:
                      condition:
                        - lambda: return disp1->is_detected();
                      then:
                        - lambda: |-
                            ESP_LOGI("${TAG_CORE_HW_DISPLAY_UART}", "Nextion detected at %" PRIu32 "bps",
                                      tf_uart->get_baud_rate());
                        - if:
                            condition:
                              - lambda: return (tf_uart->get_baud_rate() != ${BAUD_RATE});
                            then:
                              - lambda: |-
                                  ESP_LOGW("${TAG_CORE_HW_DISPLAY_UART}",
                                            "Switch to target baud rate (${BAUD_RATE} bps)");
                              - delay: 2s
                              - lambda: |-
                                  disp1->send_command("bauds=${BAUD_RATE}");
                              - delay: 2s
                              - lambda: |-
                                  tf_uart->write_str("bauds=${BAUD_RATE}");
                                  tf_uart->write_array((const uint8_t[]){0xFF, 0xFF, 0xFF}, 3);
                              - delay: 2s
                              - lambda: |-
                                  set_baud_rate->execute(${BAUD_RATE}, true);
                      else:
                        - lambda: |-
                            ESP_LOGW("${TAG_CORE_HW_DISPLAY_UART}", "Nextion was not detected at %" PRIu32 "bps",
                                      tf_uart->get_baud_rate());
                            id(baud_scan_index)++;

                            // Get the baud rates vector with our target rate first
                            const std::vector<uint32_t> baud_rates_list = {
                                ${BAUD_RATE},                              // Target baud rate first
                                921600, 115200,                            // Most common rates
                                57600, 38400, 19200, 9600,                 // Standard rates
                                512000, 256000, 250000, 31250, 4800, 2400  // Uncommon rates
                            };

                            // Check if we need to start over
                            if (id(baud_scan_index) >=  baud_rates_list.size()) {
                              id(baud_scan_index) = 0;
                              if (id(baud_scan_retries) < UINT8_MAX) {
                              id(baud_scan_retries)++;
                              }
                              if (id(baud_error_count) < UINT8_MAX) {
                              id(baud_error_count)++;
                              }
                              ESP_LOGW("${TAG_CORE_HW_DISPLAY_UART}", "Starting new scan cycle %u",
                                        id(baud_scan_retries));
                            }
                            const uint32_t current_baud = baud_rates_list[id(baud_scan_index)];
                            ESP_LOGW("${TAG_CORE_HW_DISPLAY_UART}", "Searching for Nextion at %" PRIu32, current_baud);
                            set_baud_rate->execute(current_baud, (current_baud == ${BAUD_RATE}));
                        - script.wait: set_baud_rate
                  - if:
                      condition:
                        - lambda: return disp1->is_detected();
                        - lambda: return (tf_uart->get_baud_rate() == ${BAUD_RATE});
                      then:
                        - lambda: |-
                            ESP_LOGI("${TAG_CORE_HW_DISPLAY_UART}", "Nextion detected at %" PRIu32 "bps",
                                      tf_uart->get_baud_rate());
                            if (not disp1->is_setup())
                              disp1->setup();
                        - wait_until:
                            condition: &nextion_is_setup
                              - lambda: return disp1->is_setup();
                            timeout: 5s
                        - if:
                            condition: &nextion_is_NOT_setup
                              - lambda: return not disp1->is_setup();
                            then:
                              - switch.turn_off: screen_power
                              - delay: 2s
                              - switch.turn_on: screen_power

  - id: !extend dump_config
    then:
      - script.execute: dump_config_uart

  - id: dump_config_uart
    then:
      - lambda: |-
          // Report UART
          ESP_LOGI("${TAG_CORE_HW_DISPLAY_UART}", "UART:");
          ESP_LOGI("${TAG_CORE_HW_DISPLAY_UART}", "  Baud rate:   %" PRIu32 " bps", tf_uart->get_baud_rate());
          ESP_LOGI("${TAG_CORE_HW_DISPLAY_UART}", "  Queue size:  %d", tf_uart->available());
          ESP_LOGI("${TAG_CORE_HW_DISPLAY_UART}", "  Error count: %u", id(baud_error_count));

  - id: set_baud_rate
    mode: restart
    parameters:
      baud_rate: uint32_t
      definitive: bool
    then:
      - if:
          condition:
            - lambda: return (baud_rate > 0);
            - lambda: return (baud_rate != tf_uart->get_baud_rate());
          then:
            - lambda: |-
                ESP_LOGW("${TAG_CORE_HW_DISPLAY_UART}", "Baud rate changing from %" PRIu32 " to %" PRIu32 " bps",
                          tf_uart->get_baud_rate(), baud_rate);
                ESP_LOGW("${TAG_CORE_HW_DISPLAY_UART}", "Flush UART");
            - wait_until:
                condition:
                  - lambda: return (tf_uart->available() < 1);
                timeout: 5s
            - lambda: |-
                ESP_LOGW("${TAG_CORE_HW_DISPLAY_UART}", "Sending instruction '%s=%" PRIu32 "' to Nextion",
                          definitive ? "bauds" : "baud", baud_rate);
                disp1->send_command_printf("%s=%" PRIu32, definitive ? "bauds" : "baud", baud_rate);
                ESP_LOGW("${TAG_CORE_HW_DISPLAY_UART}", "Flush UART");
            - wait_until:
                condition:
                  - lambda: return (tf_uart->available() < 1);
                timeout: 5s
            - lambda: |-
                ESP_LOGW("${TAG_CORE_HW_DISPLAY_UART}", "Set ESPHome baud rate to %" PRIu32 " bps", baud_rate);
                tf_uart->set_baud_rate(baud_rate);
                tf_uart->load_settings();
                ESP_LOGW("${TAG_CORE_HW_DISPLAY_UART}", "Current baud rate: %" PRIu32 " bps", tf_uart->get_baud_rate());

  - id: !extend stop_all
    then:
      - lambda: |-
          boot_scan_baud_rate->stop();
          dump_config_uart->stop();
          set_baud_rate->stop();

uart:
  - id: tf_uart
    tx_pin: ${GPIO_DISPLAY_NEXTION_TX_PIN}
    rx_pin: ${GPIO_DISPLAY_NEXTION_RX_PIN}
    baud_rate: ${BAUD_RATE}
...
