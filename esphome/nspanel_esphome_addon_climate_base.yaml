#####################################################################################################
##### NSPANEL ESPHOME created by Blackymas - https://github.com/Blackymas/NSPanel_HA_Blueprint  #####
##### ESPHome Add-on for Climate control - Shared - This will be called by heat/cool            #####
##### PLEASE only make changes if it is necessary and also the required knowledge is available. #####
##### For normal use with the Blueprint, no changes are necessary.                              #####
#####################################################################################################
##### ATTENTION: This will add climate elements to the core system and requires the core part.  #####
#####################################################################################################
---
substitutions:
  ##############################
  ## Change only in your      ##
  ## local yaml substitutions ##
  ##############################
  ### Local thermostat defaults ###
  # https://esphome.io/components/climate/thermostat.html
  heater_relay: "0"  # Select 1 for "Relay 1", 2 for "Relay 2" or "0" to a dummy switch/disabled
  cooler_relay: "0"  # Select 1 for "Relay 1", 2 for "Relay 2" or "0" to a dummy switch/disabled
  min_off_time: "300"
  min_run_time: "300"
  min_idle_time: "30"
  # https://esphome.io/components/climate/index.html#base-climate-configuration
  temp_min: "7"
  temp_max: "35"
  temp_step: "0.5"
  target_low: "18"
  target_high: "24"
  cool_deadband: "0.5"  # Temperature delta before engaging cooling
  cool_overrun: "0.5"   # Temperature delta before disengaging cooling
  heat_deadband: "0.5"  # Temperature delta before engaging heat
  heat_overrun: "0.5"   # Temperature delta before disengaging heat

  ##### DO NOT CHANGE THIS #####
  addon_climate_cool: "false"
  addon_climate_heat: "false"
  addon_climate_dual: "false"
  ##############################

esphome:
  platformio_options:
    build_flags:
      - -D NSPANEL_HA_BLUEPRINT_ADDON_CLIMATE_BASE

climate:
  - platform: thermostat
    name: Thermostat
    id: thermostat_embedded
    sensor: temp_nspanel
    min_idle_time: ${min_idle_time}s
    visual:
      min_temperature: ${temp_min} ${temp_units}
      max_temperature: ${temp_max} ${temp_units}
      temperature_step:
        target_temperature: 0.5  # This is hard coded for now as ESPHome isn't supporting a substitution here. In contact with support.
        current_temperature: 0.1
    default_preset: "Off"
    on_boot_restore_from: memory
    internal: false
    on_state:
      - lambda: |-
          if (is_system_flag_set(NSPanelFlag::BOOT_COMPLETED)) {
            if (current_page->state == "climate" and detailed_entity->state == "embedded_climate") {
              page_climate->execute();
            }
            page_home->execute();
          }

switch:
  ##### PHYSICAL SWITCH 0 (Dummy) - Used when relay is not set #####
  - name: Relay 0 (dummy)
    platform: template
    id: relay_0
    lambda: !lambda return false;
    internal: true
    optimistic: true

script:
  - id: !extend change_climate_state
    then:
      - if:
          condition:
            - lambda: return embedded;
          then:
            - lambda: |-
                auto FahrenheitToCelsius = [](float fahrenheit) -> float {
                  return (fahrenheit - 32.0) * 5.0 / 9.0;
                };
                std::string temp_units = "${temp_units}";
                const bool temp_unit_fahrenheit = (temp_units == "째F"
                                                || temp_units == "F"
                                                || temp_units == "째f"
                                                || temp_units == "f");
                auto call = thermostat_embedded->make_call();
                float temperature;

                disp1->set_component_value("climate.embedded", 1);
                if (key == "temperature") {
                  temperature = stof(value) / 10;
                  if (temp_unit_fahrenheit) temperature = FahrenheitToCelsius(temperature);
                  call.set_target_temperature(temperature);
                } else if (key == "target_temp_high") {
                  temperature = stof(value) / 10;
                  if (temp_unit_fahrenheit) temperature = FahrenheitToCelsius(temperature);
                  call.set_target_temperature_high(temperature);
                } else if (key == "target_temp_low") {
                  temperature = stof(value) / 10;
                  if (temp_unit_fahrenheit) temperature = FahrenheitToCelsius(temperature);
                  call.set_target_temperature_low(temperature);
                } else if (key == "hvac_mode") {
                  call.set_mode(value);
                }
                call.perform();

  - id: !extend dump_config
    then:
      - lambda: |-
          // Check if more than one or none of the climate options are defined
          #if defined(NSPANEL_HA_BLUEPRINT_ADDON_CLIMATE_COOL) && defined(NSPANEL_HA_BLUEPRINT_ADDON_CLIMATE_HEAT)
            #error "Invalid settings for add-on Climate. More than one option selected: Cool + Heat."
          #elif defined(NSPANEL_HA_BLUEPRINT_ADDON_CLIMATE_COOL) && defined(NSPANEL_HA_BLUEPRINT_ADDON_CLIMATE_DUAL)
            #error "Invalid settings for add-on Climate. More than one option selected: Cool + Dual."
          #elif defined(NSPANEL_HA_BLUEPRINT_ADDON_CLIMATE_HEAT) && defined(NSPANEL_HA_BLUEPRINT_ADDON_CLIMATE_DUAL)
            #error "Invalid settings for add-on Climate. More than one option selected: Heat + Dual."
          #elif !defined(NSPANEL_HA_BLUEPRINT_ADDON_CLIMATE_COOL) && !defined(NSPANEL_HA_BLUEPRINT_ADDON_CLIMATE_HEAT) && !defined(NSPANEL_HA_BLUEPRINT_ADDON_CLIMATE_DUAL)
            #error "Invalid settings for add-on Climate. No option selected between Cool, Heat or Dual."
          #endif
          static const char *const TAG = "nspanel_ha_blueprint";
          const uint cooler_relay = ${cooler_relay};
          const uint heater_relay = ${heater_relay};
          ESP_LOGCONFIG(TAG, "Add-on climate:");
          #ifdef NSPANEL_HA_BLUEPRINT_ADDON_CLIMATE_COOL
          ESP_LOGCONFIG(TAG, "  Cool:  Enabled");
          ESP_LOGCONFIG(TAG, "  Relay: %u", cooler_relay);
          ESP_LOGE_IF(TAG, (cooler_relay != 1 and cooler_relay != 2), "  Relay: %u", cooler_relay);
          #endif  // NSPANEL_HA_BLUEPRINT_ADDON_CLIMATE_COOL
          #ifdef NSPANEL_HA_BLUEPRINT_ADDON_CLIMATE_HEAT
          ESP_LOGCONFIG(TAG, "  Heat:  Enabled");
          ESP_LOGCONFIG(TAG, "  Relay: %u", heater_relay);
          ESP_LOGE_IF(TAG, (heater_relay != 1 and heater_relay != 2), "  Relay: %u", heater_relay);
          #endif  // NSPANEL_HA_BLUEPRINT_ADDON_CLIMATE_HEAT
          #ifdef NSPANEL_HA_BLUEPRINT_ADDON_CLIMATE_DUAL
          ESP_LOGCONFIG(TAG, "  Dual:  Enabled");
          ESP_LOGCONFIG(TAG, "  Relay (cooler): %u", cooler_relay);
          ESP_LOGE_IF(TAG, (cooler_relay != 1 and cooler_relay != 2), "  Relay (cooler): %u", cooler_relay);
          ESP_LOGCONFIG(TAG, "  Relay (heater): %u", heater_relay);
          ESP_LOGE_IF(TAG, (heater_relay != 1 and heater_relay != 2), "  Relay (heater): %u", heater_relay);
          #endif  // NSPANEL_HA_BLUEPRINT_ADDON_CLIMATE_DUAL

  - id: !extend init_hardware_climate
    then:
      - lambda: addon_climate_friendly_name = embedded_climate_friendly_name;

  - id: !extend page_climate
    then:
      - if:
          condition:
            - text_sensor.state:
                id: current_page
                state: climate
            - text_sensor.state:
                id: detailed_entity
                state: embedded_climate
          then:
            - lambda: |-
                // Temperature conversion function (constexpr for compile-time optimization)
                constexpr auto celsius_to_fahrenheit = [](float celsius) constexpr -> float {
                  return (celsius * 9.0f / 5.0f) + 32.0f;
                };

                // Constants for better performance and readability
                static const std::string temp_units = "${temp_units}";
                static const bool temp_unit_fahrenheit = (temp_units == "째F" || temp_units == "F" ||
                                                          temp_units == "째f" || temp_units == "f");

                // Get climate traits once
                const ClimateTraits traits = thermostat_embedded->get_traits();

                // Set page label and feed watchdog
                disp1->set_component_text("page_label", addon_climate_friendly_name.c_str());
                App.feed_wdt();

                // Extract temperature values (static since they don't change during runtime)
                static const float temp_step = traits.get_visual_target_temperature_step();
                static const float temp_offset = traits.get_visual_min_temperature();
                static const float temp_max = traits.get_visual_max_temperature();

                // Calculate static values once
                static float display_step, display_offset, total_steps;
                static bool values_initialized = false;

                if (!values_initialized) {
                  if (temp_unit_fahrenheit) {
                    display_step = std::ceil(temp_step * 1.8f);
                    display_offset = celsius_to_fahrenheit(temp_offset);
                    const float temp_max_f = celsius_to_fahrenheit(temp_max);
                    total_steps = (temp_max_f - display_offset) / display_step;
                  } else {
                    display_step = temp_step;
                    display_offset = temp_offset;
                    total_steps = (temp_max - temp_offset) / temp_step;
                  }
                  values_initialized = true;
                }

                // Get dynamic temperature values
                float temp_target = thermostat_embedded->target_temperature;
                float temp_target_high = thermostat_embedded->target_temperature_high;
                float temp_target_low = thermostat_embedded->target_temperature_low;
                const float temp_current = thermostat_embedded->current_temperature;

                // Convert dynamic values if using Fahrenheit
                float display_current = temp_current;
                if (temp_unit_fahrenheit) {
                  display_current = celsius_to_fahrenheit(temp_current);
                  temp_target = celsius_to_fahrenheit(temp_target);
                  temp_target_high = celsius_to_fahrenheit(temp_target_high);
                  temp_target_low = celsius_to_fahrenheit(temp_target_low);
                }

                // Single call to set_climate
                set_climate->execute(
                  display_current,                                         // current_temp
                  0,                                                       // supported_features
                  ((${addon_climate_dual}) ? -999.0f : temp_target),       // target_temp
                  ((${addon_climate_dual}) ? temp_target_high : -999.0f),  // target_temp_high
                  ((${addon_climate_dual}) ? temp_target_low : -999.0f),   // target_temp_low
                  static_cast<int>(std::round(display_step * 10.0f)),      // temp_step
                  static_cast<int>(std::round(total_steps)),               // total_steps
                  static_cast<int>(std::round(display_offset * 10.0f)),    // temp_offset
                  "",                                                      // climate_icon
                  true                                                     // embedded_climate
                );

            # Update target temp icon
            - delay: ${DELAY_DEFAULT}ms
            - script.execute:
                id: update_climate_icon
                component: target_icon
                action: int(thermostat_embedded->action)
                mode: int(thermostat_embedded->mode)

            # Update buttons bar
            # Hide not supported hotspots
            - delay: ${DELAY_DEFAULT}ms
            - lambda: |-
                disp1->hide_component("button01");
                if (${addon_climate_dual}) disp1->show_component("button02"); else disp1->hide_component("button02");
                if (${addon_climate_heat} or ${addon_climate_dual}) disp1->show_component("button03"); else disp1->hide_component("button03"); //Heat
                if (${addon_climate_cool} or ${addon_climate_dual}) disp1->show_component("button04"); else disp1->hide_component("button04"); //Cool
                disp1->hide_component("button05");
                disp1->hide_component("button06");
                disp1->show_component("button07"); //Off

            # Set buttons colors
            - delay: ${DELAY_DEFAULT}ms
            - lambda: |-
                disp1->set_component_font_color("button01", 6339);
                disp1->set_component_font_color("button02", (thermostat_embedded->mode==climate::CLIMATE_MODE_HEAT_COOL) ? 65535 : ((${addon_climate_dual}) ? 48631 : 6339));
                disp1->set_component_font_color("button03", (thermostat_embedded->mode==climate::CLIMATE_MODE_HEAT) ? 64164 : ((${addon_climate_heat} or ${addon_climate_dual}) ? 48631 : 6339));
                disp1->set_component_font_color("button04", (thermostat_embedded->mode==climate::CLIMATE_MODE_COOL) ? 1055 : ((${addon_climate_cool} or ${addon_climate_dual}) ? 48631 : 6339));
                disp1->set_component_font_color("button05", 6339);
                disp1->set_component_font_color("button06", 6339);
                disp1->set_component_font_color("button07", (thermostat_embedded->mode==climate::CLIMATE_MODE_OFF) ? 10597 : 35921);

  - id: !extend page_home
    then:
      - if:
          condition:
            - lambda: return id(is_embedded_thermostat);
          then:
            - script.execute:
                id: update_climate_icon
                component: "home.chip_climate"
                action: int(thermostat_embedded->action)
                mode: int(thermostat_embedded->mode)
...
